(file (unit (unitHead unit (namespaceName (ident PersonView)) ;) (unitInterface interface (usesClause uses (namespaceNameList (namespaceName (ident classPerson)) , (namespaceName (ident classContact)) , (namespaceName (ident classResultsArray)) , (namespaceName (ident FMX) . (ident ListBox)) , (namespaceName (ident System) . (ident SysUtils)) , (namespaceName (ident System) . (ident UITypes)) ;)) (interfaceDecl (constSection (constKey const) (constDeclaration (ident AddPerson) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident String))))) = (constExpression (expression (simpleExpression (factor (stringFactor 'Add Person'))))) ;) (constDeclaration (ident EditPerson) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident String))))) = (constExpression (expression (simpleExpression (factor (stringFactor 'Edit Person'))))) ;))) (interfaceDecl (varSection (varKey var) (varDeclaration (identListFlat (ident PersonID)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))) ;) (varDeclaration (identListFlat (ident NumContactsToAdd)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))) ;))) (interfaceDecl (procDecl (procDeclHeading procedure (ident ClearListBox)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddPersonToListBox) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident Person)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TPerson))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddContactToListBox) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident Contact)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TContact))))))) ))) ;)) interfaceDecl (interfaceDecl procedure EditPersonListBox ( Person : TPerson ; Contacts : Array of TContact ) ;) (interfaceDecl (procDecl (procDeclHeading procedure (ident DeletePersonFromListBox) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident PersonID)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident UpdatePersonIDs) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident ResultsArray)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TResultsArray))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident UpdateContactIDs) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident ResultsArray)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TResultsArray))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident SetEditPersonItem) (formalParameterSection ( (formalParameterList (formalParameter (parmType const) (identListFlat (ident Item)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TListBoxItem))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident SetAddNewPerson)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddPersonRemoveContact) (formalParameterSection ( (formalParameterList (formalParameter (parmType const) (identListFlat (ident Item)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TListBoxItem))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddNewContact)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddPersonCancel)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddPersonSave)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddPersonDelete)) ;))) (unitImplementation implementation (usesClause uses (namespaceNameList (namespaceName (ident Main)) , (namespaceName (ident PersonController)) , (namespaceName (ident ClientsTabView)) , (namespaceName (ident BookingsTabController)) ;)) (declSection (procDecl (procDeclHeading procedure (ident ClearListBox)) ; (procBody (block (blockBody (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident MainForm) . (ident lbPeople)) . (qualifiedIdent (ident Clear)))))) ; (statement (simpleStatement designator))) end))) ;))) (declSection (procDecl (procDeclHeading procedure (ident AddPersonToListBox) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident Person)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TPerson))))))) ))) ; (procBody (block (declSection (varSection (varKey var) (varDeclaration (identListFlat (ident Item)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TListBoxItem))))) ;))) (blockBody (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident Item)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident TListBoxItem)) . (qualifiedIdent (ident Create))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident MainForm)) . (qualifiedIdent (ident lbPeople))))))) )))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item)) . (qualifiedIdent (ident Text)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person) . (ident PersonID)) . (qualifiedIdent (ident ToString))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item) . (ident ItemData)) . (qualifiedIdent (ident Detail)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person)) . (qualifiedIdent (ident ToString))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item)) . (qualifiedIdent (ident Data)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Person))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item)) . (qualifiedIdent (ident StyleLookup)))) := (expression (simpleExpression (factor (stringFactor 'HeaderListBoxItem')))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident MainForm) . (ident lbPeople)) . (qualifiedIdent (ident AddObject))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Item))))))) ))))) ; (statement (simpleStatement designator))) end))) ;))) (declSection (procDecl (procDeclHeading procedure (ident AddContactToListBox) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident Contact)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TContact))))))) ))) ; (procBody (block (declSection (varSection (varKey var) (varDeclaration (identListFlat (ident Item)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TListBoxItem))))) ;))) (blockBody (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident Item)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident TListBoxItem)) . (qualifiedIdent (ident Create))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident MainForm)) . (qualifiedIdent (ident lbPeople))))))) )))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item)) . (qualifiedIdent (ident Text)))) := (expression (simpleExpression (factor (stringFactor 'Contact')) (operator +) (factor (designator (namespacedQualifiedIdent (namespaceName (ident Contact) . (ident PersonID)) . (qualifiedIdent (ident ToString))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item)) . (qualifiedIdent (ident Data)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Contact))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item) . (ident ItemData)) . (qualifiedIdent (ident Detail)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Contact)) . (qualifiedIdent (ident ToString))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Item)) . (qualifiedIdent (ident StyleLookup)))) := (expression (simpleExpression (factor (stringFactor 'SubListBoxItem')))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident MainForm) . (ident lbPeople)) . (qualifiedIdent (ident AddObject))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Item))))))) ))))) ; (statement (simpleStatement designator))) end))) ;))) declSection (declSection procedure EditPersonListBox ( Person : TPerson ; Contacts : Array of TContact ) ;) (declSection (varSection (varKey var) (varDeclaration (identListFlat (ident PersonIndex)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))) ;) (varDeclaration (identListFlat (ident I)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))) ;)))) (unitBlock (compoundStatement begin (statementList (statement (withStatement with (withItem (designator (namespacedQualifiedIdent (namespaceName (ident MainForm)) . (qualifiedIdent (ident lbPeople))))) do (statement (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Items)) . (qualifiedIdent (ident IndexOf))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person) . (ident PersonID)) . (qualifiedIdent (ident ToString))))))) )))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident ListItems))) (designatorItem [ (expressionList (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex)))))))) ]) (designatorItem . (ident ItemData)) (designatorItem . (ident Detail))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person)) . (qualifiedIdent (ident ToString))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident ListItems))) (designatorItem [ (expressionList (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex)))))))) ]) (designatorItem . (ident Data))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Person))))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident I)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Items)) . (qualifiedIdent (ident IndexOf))) (designatorItem ( (expression (simpleExpression (factor (stringFactor 'Contact')) (operator +) (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person) . (ident PersonID)) . (qualifiedIdent (ident ToString))))))) )))))))) ; (statement (whileStatement while (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident I)))))) (relOp <>) (simpleExpression (factor - (factor (intNum 1))))) do (statement (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Items)) . (qualifiedIdent (ident Delete))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident I))))))) ))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident I)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (namespaceName (ident Items)) . (qualifiedIdent (ident IndexOf))) (designatorItem ( (expression (simpleExpression (factor (stringFactor 'Contact')) (operator +) (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person) . (ident PersonID)) . (qualifiedIdent (ident ToString))))))) )))))))) ; (statement (simpleStatement designator))) end)))) ; (statement (forStatement for (designator (namespacedQualifiedIdent (qualifiedIdent (ident I)))) := (expression (simpleExpression (factor (intNum 0)))) to (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Length))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Contacts))))))) )))) (operator -) (factor (intNum 1)))) do (statement (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident Items)) . (qualifiedIdent (ident InsertObject))) (designatorItem ( (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex))))) (operator +) (factor (intNum 1)))) , (expression (simpleExpression (factor (stringFactor 'Contact')) (operator +) (factor (designator (namespacedQualifiedIdent (namespaceName (ident Person) . (ident PersonID)) . (qualifiedIdent (ident ToString))))))) , (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Contacts))) (designatorItem [ (expressionList (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident I)))))))) ]))))) ))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident ListItems))) (designatorItem [ (expressionList (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex))))) (operator +) (factor (intNum 1))))) ]) (designatorItem . (ident ItemData)) (designatorItem . (ident Detail))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident Contacts))) (designatorItem [ (expressionList (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident I)))))))) ]) (designatorItem . (ident ToString)))))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident ListItems))) (designatorItem [ (expressionList (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex))))) (operator +) (factor (intNum 1))))) ]) (designatorItem . (ident StyleLookup))) := (expression (simpleExpression (factor (stringFactor 'SubListBoxItem')))))) ; (statement (simpleStatement (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex)))) := (expression (simpleExpression (factor (designator (namespacedQualifiedIdent (qualifiedIdent (ident PersonIndex))))) (operator +) (factor (intNum 1)))))) ; (statement (simpleStatement designator))) end)))) ; (statement (simpleStatement designator))) end)))) ; (statement (simpleStatement designator))) end)) ; procedure DeletePersonFromListBox ( PersonID : Integer ) ; var I : Integer ; begin with MainForm . lbPeople do begin I := Items . IndexOf ( PersonID . ToString ) ; ListItems [ I ] . Free ; I := Items . IndexOf ( 'Contact' + PersonID . ToString ) ; while I <> - 1 do begin ListItems [ I ] . Free ; I := Items . IndexOf ( 'Contact' + PersonID . ToString ) ; end ; end ; end ; procedure UpdatePersonIDs ( ResultsArray : TResultsArray ) ; var I : Integer ; J : Integer ; test : string ; Person : TPerson ; Contact : TContact ; begin with MainForm . lbPeople do begin for I := 0 to Count - 1 do begin if ListItems [ I ] . Data . ToString = 'TPerson' then begin Person := ListItems [ I ] . Data as TPerson ; if Person . PersonID < 0 then begin for J := 0 to ResultsArray . GetLen - 1 do begin if Person . PersonID = ResultsArray . GetID ( J ) . OldID then begin Person . PersonID := ResultsArray . GetID ( J ) . NewID ; ListItems [ I ] . Data := Person ; ListItems [ I ] . Text := Person . PersonID . ToString ; test := Person . ToString ; ListItems [ I ] . ItemData . Detail := Person . ToString ; test := ListItems [ I ] . ItemData . Detail ; test := '' ; Break ; end ; end ; end ; end else if ListItems [ I ] . Data . ToString = 'TContact' then begin Contact := ListItems [ I ] . Data as TContact ; if Contact . PersonID < 0 then begin for J := 0 to ResultsArray . GetLen - 1 do begin if Contact . PersonID = ResultsArray . GetID ( J ) . OldID then begin Contact . PersonID := ResultsArray . GetID ( J ) . NewID ; ListItems [ I ] . Data := Contact ; ListItems [ I ] . Text := 'Contact' + Contact . PersonID . ToString ; ListItems [ I ] . ItemData . Detail := Contact . ToString ; Break ; end ; end ; end ; end ; end ; end ; end ; procedure UpdateContactIDs ( ResultsArray : TResultsArray ) ; var I : Integer ; J : Integer ; Contact : TContact ; begin with MainForm . lbPeople do begin for I := 0 to Count - 1 do begin if ListItems [ I ] . Data . ToString = 'TPerson' then begin end else if ListItems [ I ] . Data . ToString = 'TContact' then begin Contact := ListItems [ I ] . Data as TContact ; if Contact . ID < 0 then begin for J := 0 to ResultsArray . GetLen - 1 do begin if Contact . ID = ResultsArray . GetID ( J ) . OldID then begin Contact . ID := ResultsArray . GetID ( J ) . NewID ; ListItems [ I ] . Data := Contact ; ListItems [ I ] . ItemData . Detail := Contact . ToString ; Break ; end ; end ; end ; end ; end ; end ; end ; procedure SetEditPersonItem ( const Item : TListBoxItem ) ; var Person : TPerson ; Contact : TContact ; I : Integer ; begin with MainForm do begin bAddPersonDelete . Enabled := True ; Person := Item . Data as TPerson ; lAddPerson . Text := EditPerson ; PersonID := Person . PersonID ; eAddPersonLastName . Text := Person . Last ; eAddPersonFirstName . Text := Person . First ; eAddPersonNotes . Text := Person . Notes ; eContactEmail . Text := '' ; eContactPhone . Text := '' ; eContactType . Text := '' ; lbContact . Clear ; for I := 0 to lbPeople . Count - 1 do begin if lbPeople . Items [ I ] = 'Contact' + Person . PersonID . ToString then begin Contact := lbPeople . ListItems [ I ] . Data as TContact ; lbContact . Items . AddObject ( Contact . ToString , Contact ) ; end ; end ; OpenPanel ( PanelAddPerson ) ; end ; end ; procedure SetAddNewPerson ; begin with MainForm do begin bAddPersonDelete . Enabled := False ; lAddPerson . Text := AddPerson ; PersonID := - ( lbPeople . Count ) - 1 ; eAddPersonLastName . Text := '' ; eAddPersonFirstName . Text := '' ; eAddPersonNotes . Text := '' ; eContactEmail . Text := '' ; eContactPhone . Text := '' ; eContactType . Text := '' ; lbContact . Clear ; OpenPanel ( panelAddPerson ) ; end ; end ; procedure AddPersonRemoveContact ( const Item : TListBoxItem ) ; var Contact : TContact ; I : Integer ; begin Contact := Item . Data as TContact ; I := MainForm . lbContact . Items . IndexOf ( Contact . ToString ) ; MainForm . lbContact . Items . Delete ( I ) ; end ; procedure AddNewContact ; var Contact : TContact ; Email : String ; Curr : Char ; I , Step : Integer ; Error : Boolean ; begin with MainForm do begin if ( eContactType . Text <> '' ) or ( eContactPhone . Text <> '' ) or ( eContactEmail . Text <> '' ) then begin Error := False ; if eContactEmail . Text <> '' then begin Email := eContactEmail . Text ; Step := 0 ; for I := 1 to Email . Length do begin Curr := Email [ I ] ; if not ( Curr in [ 'a' .. 'z' , 'A' .. 'Z' , '0' .. '9' , '_' ] ) then begin if ( Step = 0 ) and ( Curr = '@' ) then begin Step := 1 ; end else if ( Step = 1 ) and ( Curr = '.' ) then begin Step := 2 ; end ; end else begin if Step = 2 then begin Step := 3 ; end ; end ; end ; if Step <> 3 then begin Error := True ; end ; end ; if Error = False then begin Contact := TContact . Create ( - ( lbPeople . Count ) - 2 - NumContactsToAdd , PersonID , eContactType . Text , eContactPhone . Text , eContactEmail . Text ) ; lbContact . Items . AddObject ( Contact . ToString , Contact ) ; lContactEmail . FontColor := TAlphaColorRec . Black ; eContactType . Text := '' ; eContactPhone . Text := '' ; eContactEmail . Text := '' ; Inc ( NumContactsToAdd , 1 ) ; end else begin lContactEmail . FontColor := TAlphaColorRec . Red ; end ; end ; end ; end ; procedure AddPersonCancel ; begin with MainForm do begin ClosePanel ( panelAddPerson ) ; end ; end ; procedure AddPersonSave ; var Person : TPerson ; Contacts : Array of TContact ; Size : Integer ; I : Integer ; begin with MainForm do begin Person := TPerson . Create ( PersonID , BookingsTabController . CurrentBookingID , eAddPersonLastName . Text , eAddPersonFirstName . Text , eAddPersonNotes . Text ) ; Size := lbContact . Count ; if Size > 0 then begin SetLength ( Contacts , Size ) ; for I := 0 to Size - 1 do begin Contacts [ I ] := lbContact . ListItems [ I ] . Data as TContact ; end ; end ; if ( eContactType . Text <> '' ) or ( eContactPhone . Text <> '' ) or ( eContactEmail . Text <> '' ) then begin AddNewContact ; end ; Size := Length ( Contacts ) ; if lAddPerson . Text = AddPerson then begin PersonController . AddPerson ( Person , Contacts ) ; AddPersonToListBox ( Person ) ; for I := 0 to Size - 1 do begin AddContactToListBox ( Contacts [ I ] ) ; end ; end else if lAddPerson . Text = EditPerson then begin PersonController . EditPerson ( Person , Contacts ) ; EditPersonListBox ( Person , Contacts ) ; end ; NumContactsToAdd := 0 ; cbClientsSave . IsChecked := False ; lContactEmail . FontColor := TAlphaColorRec . Black ; ClosePanel ( panelAddPerson ) ; ClientsTabView . ClientSave ; end ; end ; procedure AddPersonDelete ; begin PersonController . DeletePerson ( PersonID ) ; DeletePersonFromListBox ( PersonID ) ; MainForm . cbClientsSave . IsChecked := False ; MainForm . ClosePanel ( MainForm . panelAddPerson ) ; ClientsTabView . ClientSave ; end ; end .))