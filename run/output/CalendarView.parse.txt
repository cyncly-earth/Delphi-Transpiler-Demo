(file (unit (unitHead unit (namespaceName (ident CalendarView)) ;) (unitInterface interface (usesClause uses (namespaceNameList (namespaceName (ident classCalendarItem)) , (namespaceName (ident classRental)) , (namespaceName (ident classEmailUser)) , (namespaceName (ident Misc)) , (namespaceName (ident SysUtils)) , (namespaceName (ident System) . (ident UITypes)) , (namespaceName (ident FMX) . (ident TMSPlannerData)) , (namespaceName (ident DateUtils)) , (namespaceName (ident FMX) . (ident Graphics)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident Clear)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident CalendarChange) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident nDate)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TDate))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AfterSelect)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident SetItemResource) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident Item)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TTMSFMXPlannerItem)))))) ; (formalParameter (identListFlat (ident AccomID)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading function (ident AddBedroomSlot) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident CalendarItem)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TCalendarItem)))))) ; (formalParameter (identListFlat (ident AccomID)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident Integer))))))) )) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TTMSFMXPlannerItem)))))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident AddItemToCalendar) (formalParameterSection ( (formalParameterList (formalParameter (identListFlat (ident CalendarItem)) : (typeDecl (typeId (namespacedQualifiedIdent (qualifiedIdent (ident TCalendarItem))))))) ))) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident SwitchToCalendar)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident BookingsCalendarClick)) ;)) (interfaceDecl (procDecl (procDeclHeading procedure (ident ExportCalendar)) ;)) (interfaceDecl (constSection (constKey const)))) (unitImplementation TitleColors : Array of Integer = [ $FFDB7093 , $FF3CB371 , $FFFFFFFF , $FFFA8072 , $FF4169E1 , $FFFFFFFF , $FFCD853F , $FFFFA500 , $FF00CED1 ] ; ItemColors : Array of Integer = [ $FFFFB6C1 , $FF90EE90 , $FF000000 , $FFFFA07A , $FF87CEFA , $FF000000 , $FFF5DEB3 , $FFFAFAD2 , $FF7FFFD4 ] ; TitleFontColor = $FFFFFFFF ; TextFontColor = $FF000000 ; implementation uses Main , CalendarController ; procedure Clear ;) (unitBlock (compoundStatement begin (statementList (statement (simpleStatement (designator (namespacedQualifiedIdent (namespaceName (ident MainForm) . (ident Planner) . (ident Items)) . (qualifiedIdent (ident Clear)))))) ; (statement (simpleStatement designator))) end)) ; procedure CalendarChange ( nDate : TDate ) ; begin ReplaceTime ( TDateTime ( nDate ) , EncodeTime ( 0 , 0 , 0 , 0 ) ) ; with MainForm do begin Planner . BeginUpdate ; Planner . ModeSettings . StartTime := IncDay ( nDate , - 7 ) ; Planner . TimeLine . ViewStart := IncDay ( nDate , - 3 ) ; Planner . ModeSettings . EndTime := IncDay ( nDate , 14 ) ; try if IsConnected then begin CalendarController . UpdateCalendar ( Planner . ModeSettings . StartTime , Planner . ModeSettings . EndTime ) ; end ; except on E : Exception do begin MainForm . circleOnlineStatus . Fill . Color := TAlphaColorRec . Red ; Print ( 'ERROR: ' + E . ClassName + sLineBreak + E . Message ) ; end ; end ; Planner . EndUpdate ; end ; end ; procedure AfterSelect ; begin MainForm . Planner . SelectItem ( - 1 ) ; end ; procedure SetItemResource ( Item : TTMSFMXPlannerItem ; AccomID : Integer ) ; begin if AccomID in [ 2 .. 3 ] then AccomID := AccomID - 2 else if AccomID in [ 4 .. 5 ] then AccomID := AccomID - 1 else if AccomID in [ 6 .. 7 ] then AccomID := AccomID else if AccomID in [ 8 .. 9 ] then AccomID := AccomID - 7 else if AccomID in [ 10 .. 11 ] then AccomID := AccomID - 6 else AccomID := 8 ; Item . Resource := AccomID ; if ( AccomID = 2 ) or ( AccomID = 5 ) then AccomID := AccomID - 1 ; Item . TitleColor := TitleColors [ AccomID ] ; Item . Color := ItemColors [ AccomID ] ; end ; function AddBedroomSlot ( CalendarItem : TCalendarItem ; AccomID : Integer ) : TTMSFMXPlannerItem ; begin if AccomID = 3 then AccomID := 1 else if AccomID = 5 then AccomID := 4 ; Result := MainForm . Planner . AddItem ( CalendarItem . StartDate , CalendarItem . EndDate ) ; Result . Color := ItemColors [ AccomID ] ; Result . Title := ' ' ; Result . DataObject := CalendarItem ; Result . Resource := AccomID + 1 ; if CalendarItem . Status = 'Quote' then Result . TitleColor := TAlphaColorRec . DarkRed else if CalendarItem . Status = 'Booking' then Result . TitleColor := TAlphaColorRec . Navy else if CalendarItem . Status = 'Cancelled' then Result . TitleColor := TAlphaColorRec . Black else Result . TitleColor := TitleColors [ AccomID ] ; end ; procedure AddItemToCalendar ( CalendarItem : TCalendarItem ) ; var Item : TTMSFMXPlannerItem ; begin Item := MainForm . Planner . AddItem ( CalendarItem . StartDate , CalendarItem . EndDate ) ; Item . Title := '$' + CalendarItem . Outstanding . ToString ; Item . TitleFontColor := TitleFontColor ; Item . Text := CalendarItem . ToString ; Item . FontColor := TextFontColor ; Item . DataObject := CalendarItem ; SetItemResource ( Item , CalendarItem . AccomID ) ; if CalendarItem . AccomID = 3 then begin AddBedroomSlot ( CalendarItem , 3 ) ; end else if CalendarItem . AccomID = 5 then begin AddBedroomSlot ( CalendarItem , 5 ) ; end ; if CalendarItem . Status = 'Quote' then Item . TitleColor := TAlphaColorRec . DarkRed else if CalendarItem . Status = 'Booking' then Item . TitleColor := TAlphaColorRec . Navy else if CalendarItem . Status = 'Cancelled' then Item . TitleColor := TAlphaColorRec . Black ; end ; procedure SwitchToCalendar ; begin MainForm . TabControl1 . ActiveTab := MainForm . TabControl1 . Tabs [ 3 ] ; end ; procedure BookingsCalendarClick ; var Rental : TRental ; begin if MainForm . lbRental . Count > 0 then begin Rental := MainForm . lbRental . ListItems [ 0 ] . Data as TRental ; MainForm . Calendar . Date := Rental . StartDate ; CalendarChange ( Rental . StartDate ) ; SwitchToCalendar ; end ; end ; procedure ExportCalendar ; var EmailUser : TEmailUser ; begin with MainForm do begin EmailUser := TEmailUser . Create ( Misc . EmailAddress , eEmailname . Text ) ; CalendarController . EmailBitmap ( Planner . MakeScreenshot , eCalendarEmail . Text , EmailUser , eCalendarMessage . Text ) ; end ; end ; end .))